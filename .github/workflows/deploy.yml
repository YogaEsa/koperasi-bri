name: Deploy Laravel to Hostinger

on:
  push:
    branches: [ main ] # Ganti sesuai branch utama Anda

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Build Frontend Assets
        run: |
          npm ci
          npm run build

      - name: Copy Assets via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT || 22 }}
          source: "public/build"
          target: "/home/u543874255/domains/dev.jati-jajar.com/public_html"

      - name: Deploy Backend via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT || 22 }}
          script: |
            # Debugging: Cek direktori saat ini
            echo "ğŸ“‚ Current directory:"
            pwd

            # Masuk ke direktori project yang benar
            cd /home/u543874255/domains/dev.jati-jajar.com/public_html || exit 1

            # Check PHP version
            echo "ğŸ” Checking PHP version..."
            php -v

            # Check required extensions
            echo "ğŸ” Checking required PHP extensions..."
            php -m | grep -E "pdo|mbstring|openssl|tokenizer|xml|ctype|json|bcmath|fileinfo"

            # Pull latest code
            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main || exit 1

            # Install/Update PHP dependencies
            echo "ğŸ“¦ Installing Composer dependencies..."
            composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader --ignore-platform-reqs || {
              echo "âŒ Composer install failed. Trying with platform requirements check..."
              composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader
            }

            # Clear all caches before recaching
            echo "ğŸ§¹ Clearing caches..."
            php artisan cache:clear
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear

            # Run migrations
            echo "ğŸ—„ï¸ Running migrations..."
            php artisan migrate --force || exit 1

            # Optimize for production
            echo "âš¡ Optimizing for production..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # Create storage link if not exists
            echo "ğŸ”— Creating storage link..."
            php artisan storage:link || true

            # Set proper permissions
            echo "ğŸ”’ Setting permissions..."
            chmod -R 775 storage bootstrap/cache

            echo "âœ… Deployment completed successfully!"
