name: Deploy Laravel to Hostinger

on:
  push:
    branches: [ main ] # Ganti sesuai branch utama Anda

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT || 22 }}
          script: |
            # Ganti 'public_html' dengan path project Anda di server
            cd public_html || exit 1

            # Pull latest code
            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main || exit 1

            # Install/Update PHP dependencies
            echo "ğŸ“¦ Installing Composer dependencies..."
            composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader || exit 1

            # Install/Update Node dependencies
            echo "ğŸ“¦ Installing NPM dependencies..."
            npm ci --omit=dev || exit 1

            # Build frontend assets (PENTING untuk Vite)
            echo "ğŸ”¨ Building frontend assets..."
            npm run build || exit 1

            # Clear all caches before recaching
            echo "ğŸ§¹ Clearing caches..."
            php artisan cache:clear
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear

            # Run migrations
            echo "ğŸ—„ï¸ Running migrations..."
            php artisan migrate --force || exit 1

            # Optimize for production
            echo "âš¡ Optimizing for production..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # Create storage link if not exists
            echo "ğŸ”— Creating storage link..."
            php artisan storage:link || true

            # Set proper permissions
            echo "ğŸ”’ Setting permissions..."
            chmod -R 775 storage bootstrap/cache

            echo "âœ… Deployment completed successfully!"
